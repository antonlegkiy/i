<style>
  label {
    margin-bottom: 0;
  }
</style>

<div class="tasks-form-view">
  <show-error data="error" ng-show="error"></show-error>

  <div class="task-view-info">
    <h4 ng-show="sSelectedTask == 'all' && selectedTask.assignee">Призначено на: {{selectedTask.assignee}}</h4>
    <h4 ng-show="sSelectedTask == 'all' && selectedTask.assignee == null">Вільний тікет</h4>
    <button ng-show="sSelectedTask == 'all' && selectedTask.assignee" ng-click="unassign()" class="btn btn-success">Відкріпити</button>
  </div>

  <!--номер заявки и дата подачи-->
  <div class="task-number-date" style="margin-bottom: 30px">
    <h3 ng-class="{'display-inline-block':!inUnassigned()}">{{nID_Process + lunaService.getLunaValue(nID_Process)}}</h3>
    <span ng-class="{'float-right':!inUnassigned()}">від {{creationDateFormatted(taskData.sDateTimeCreate)}}</span>
  </div>

  <div class="btn-group task-form-tabs" ng-if="!inUnassigned()">
    <a href='#' ng-class="{'tab-is-selected' : tabHistoryAppeal === 'appeal'}"
                class="btn btn-link"
                ng-click="tabHistoryAppealChange('appeal')">Звернення</a>
    <a href='#' ng-class="{'tab-is-selected' : tabHistoryAppeal === 'history'}"
                class="btn btn-link"
                ng-click="tabHistoryAppealChange('history')">Історія діалогу</a>
  </div>

  <div ng-if="!clarify">
    <div ng-hide="selectedTask.assignee != null || sSelectedTask == 'all'">
      <button ng-click="assignTask()"
              class="btn btn-info take-to-work-button"
              style="background-color: #337ACF; outline: none; border: none"
              ng-disabled="isTaskSuccessfullySubmitted() || isTaskInProcess()"
              ng-show="selectedTask.assignee == null">Взяти в роботу
      </button>
      <label ng-show="isTaskInProcess() && !isTaskSuccessfullySubmitted()">&nbsp;&nbsp;Зачекайте...</label>
      <label ng-show="isTaskSuccessfullySubmitted()">&nbsp;&nbsp;Задачу направлено в роботу.</label>
    </div>
  </div>

  <!--форма заявки-->
  <div ng-if="tabHistoryAppeal === 'appeal' && !clarify">
    <form name="form" novalidate>
      <div ng-repeat="item in taskForm" class="task-form-property row" ng-if="isFieldVisible(item)">

        <!--поле типа simple-field-->
        <div ng-if="item.value && isFormPropertyDisabled(item)">
          <simple-field></simple-field>
        </div>

        <!--поле типа date-->
        <div ng-if="item.value && isFormPropertyDisabled(item)">
          <date-field></date-field>
        </div>

        <!--поле типа text-area-->
        <div ng-if="item.value && isFormPropertyDisabled(item)">
          <textarea-field></textarea-field>
        </div>

        <!--поле типа enum-->
        <div ng-if="item.value && isFormPropertyDisabled(item)">
          <enum-field></enum-field>
        </div>

        <!--поле типа user-->
        <p ng-if="item.type == 'user'">
          <label>{{sFieldLabel(item.name)}}</label>
          <input class="form-control"
                 name="{{item.id}}"
                 ng-disabled="true"
                 ng-required="{{item.required}}"
                 ng-model="item.value"
                 ng-class="{submitted:item.required && isTaskSubmitted()}"/>
        </p>

        <!--поле типа marker-->
        <label style="display: none;"
               ng-if="item.type == 'markers'"
               name="{{item.id}}"
               ng-required="{{item.required}}"
               class="form-control_">{{item.value}}
        </label>

        <span style="display: none;" ng-if="['invisible'].indexOf(item.type) > -1">
          <label>{{sFieldLabel(item.name)}} {{item.required && item.writable ? "*" : ""}}</label>
        </span>

        <span ng-if="['label'].indexOf(item.type) > -1 && item.value">
          <span class="col-sm-6 task-form-title" >
            <label>{{sFieldLabel(item.name)}} {{item.required && item.writable ? "*" : ""}}</label>
          </span>
          <span class="col-sm-6 task-form-written-right-sight">
            <label>{{item.value}}</label>
          </span>
        </span>

        <span ng-if="['queueData'].indexOf(item.type) > -1">
          <span class="col-sm-6 task-form-title">
            <label>{{sFieldLabel(item.name)}} {{item.required && item.writable ? "*" : ""}}</label>
          </span>
          <span class="col-sm-6 task-form-written-right-sight">
            <label title="{{nID_FlowSlotTicket_FieldQueueData(item.value)}}">{{sDate_FieldQueueData(item.value)}}</label>
          </span>
        </span>

        <div class="col-sm-6">
          <div ng-if="clarify && item.writable && (item.type==='string' || item.type==='textArea' || item.type==='date')"> <!--item.writable-->
            <input type="checkbox" ng-model="clarifyFields[item.id].clarify" id="{{item.id}}_clarify"/>
            <label for="{{item.id}}_clarify">Уточнити</label>
            <div ng-if="clarifyFields[item.id].clarify">
            <textarea ng-model="clarifyFields[item.id].text" class="form-control"
                      placeholder="Уточнення для {{sFieldLabel(item.name)}}">
            </textarea>
            </div>
          </div>
        </div>
      </div>

      <!--редактируемые поля для чиновника-->
      <hr class="hr-divider">
      <div ng-repeat="item in taskForm" class="task-form-property row" ng-if="isFieldVisible(item)">
        <!--поле типа simple-field-->
        <div ng-if="!isFormPropertyDisabled(item)">
          <simple-field></simple-field>
        </div>

        <!--поле типа date-->
        <div ng-if="!isFormPropertyDisabled(item)">
          <date-field></date-field>
        </div>

        <!--поле типа text-area-->
        <div ng-if="!isFormPropertyDisabled(item)">
          <textarea-field></textarea-field>
        </div>

        <!--поле типа enum-->

        <div ng-if="!isFormPropertyDisabled(item)">
          <enum-field></enum-field>
        </div>

        <!--поле типа file-->
        <span ng-if="item.type == 'file' && !isFormPropertyDisabled(item) && item.id.indexOf('PrintForm') === -1"
              ng-class="{submitted:item.required && isTaskSubmitted()}"
              class="col-sm-12">
          <span class="col-sm-6 task-form-title">
            <label>{{sFieldLabel(item.name)}} <span ng-if="item.required && item.writable" style="color: red">*</span></label>
          </span>
          <span class="col-sm-6">
            <file-field name="{{item.id}}"
                        ng-disabled="isFormPropertyDisabled(item)"
                        ng-model="item.value"
                        ng-required="{{item.required}}">Add File
            </file-field>
          </span>
        </span>
      </div>

      <div class="control-form-fields" ng-if="taskData.aAttachment.length > 0 && !inUnassigned()">
        <div class="addition-hr">
          <hr class="hr-divider side-left"><span>Додатки</span><hr class="hr-divider side-right">
        </div>

        <div>
          <div ng-repeat="item in taskData.aAttachment" style="display: inline-block; position:relative;">
            <div class="like-modal">
              <p>{{item.description}}</p>
              <a href="/api/tasks/{{taskId}}/attachments/{{item.id}}/content/{{($index+1)}}"
                 target="_blank"
                 class="btn btn-info">Завантажити
              </a>
              <button
                class="btn btn-info"
                ng-disabled="checkSignState.inProcess"
                ng-click="checkAttachmentSign(taskId, item.id, item.description)"
                ng-if="sSelectedTask=='selfAssigned'">Перевірити ЕЦП
              </button>
            </div>
            <button style="position:relative;"
                    type="button"
                    class="btn btn-link attach-btn"
                    ng-model="some"
                    ng-click="openModalWindow($event)">
              {{item.description | cut : true : 25}}
            </button>
          </div>
        </div>
      </div>

      <div class="control-form-fields" ng-if="!inUnassigned()">
        <hr class="hr-divider">
        <div class="main-form-controls" ng-init="checkForEmpty()">
          <div ng-if="!clarify" style="display: inline-block;">
            <div ng-hide="selectedTask.assignee == null || sSelectedTask == 'all'">
              <button ng-hide="selectedTask.assignee == null || sSelectedTask == 'finished'"
                      ng-click="submitTask(form)"
                      class="btn btn-info"
                      style="background-color: #337ACF; outline: none; border: none"
                      ng-disabled="isTaskSuccessfullySubmitted() || isTaskInProcess()">Опрацювати
              </button>
              <label ng-show="isTaskInProcess()&& !isTaskSuccessfullySubmitted()">&nbsp;&nbsp;Зачекайте...</label>
              <label ng-show="isTaskSuccessfullySubmitted()">&nbsp;&nbsp;Задачу опрацьовано.</label>
            </div>
          </div>

          <div ng-hide="selectedTask.assignee === null || sSelectedTask === 'finished' || sSelectedTask === 'all' || selectedTask.processDefinitionId.indexOf('system') == 0" style="padding-top:5px; display: inline-block; position:relative;">
            <div class="print-form-div" style="position:absolute; display: none;">
              <div ng-repeat="item in printTemplateList">
                <a href="#" ng-click="tryToPrint(form, item)">{{item.displayTemplate}}</a>
              </div>
            </div>
            <button ng-if="printTemplateList.length > 0" ng-click="openModalWindow($event)" class="btn btn-link">Роздрукувати <i style="font-size: 11px" class="glyphicon glyphicon-chevron-down"></i></button>
            <button ng-if="printTemplateList.length === 0" ng-click="print()" class="btn btn-link">Роздрукувати</button>
            <!--<select class="aPatternPrint form-control" ng-options="option.displayTemplate for option in printTemplateList track by option.id" ng-required ng-model="model.printTemplate" ng-hide="printTemplateList.length == 0 || selectedTask.assignee === null || sSelectedTask === 'finished'" >-->
            <!--</select>-->
          </div>

          <div style="display: inline-block;">
            <div class="tasks-form-buttons-clarify" ng-if="sSelectedTask=='selfAssigned' && selectedTask.processDefinitionId.indexOf('system') != 0 && !isTaskSuccessfullySubmitted()">
              <button ng-if="!clarify" type="button" class="btn btn-link" ng-click="clarifyToggle()">Внести зауваження</button>
              <div ng-if="clarify" style="padding-top:5px;">
                <textarea class="form-control" placeholder="Коментар до зауваження" ng-model="clarifyModel.sBody"></textarea>
                <button type="button" class="btn btn-link" ng-click="clarifySend()">Відправити зауваження</button>
                <button type="button" class="btn btn-default" ng-click="clarifyToggle()">Відміна</button>
              </div>
            </div>
          </div>

          <div style="display:inline-block;">
            <button class="btn btn-warning" style="border: none">Очікую відповідь</button>
          </div>

        </div>
      </div>
    </form>
  </div>

  <div ng-if="clarify">
    <clarify-directive ng-if="tabHistoryAppeal !== 'history'"></clarify-directive>
  </div>

  <div class="task-form-history" ng-if="tabHistoryAppeal === 'history'">
    <div ng-if="!inUnassigned()" ng-include="'app/tasks/taskFormHistoryNew.html'"></div>
  </div>

  <div ng-if="!clarify">
    <div ng-hide="selectedTask.assignee != null || sSelectedTask == 'all'">
      <button ng-click="assignTask()"
              class="btn btn-info take-to-work-button"
              style="background-color: #337ACF; outline: none; border: none"
              ng-disabled="isTaskSuccessfullySubmitted() || isTaskInProcess()"
              ng-show="selectedTask.assignee == null">Взяти в роботу
      </button>
      <label ng-show="isTaskInProcess() && !isTaskSuccessfullySubmitted()">&nbsp;&nbsp;Зачекайте...</label>
      <label ng-show="isTaskSuccessfullySubmitted()">&nbsp;&nbsp;Задачу направлено в роботу.</label>
    </div>
  </div>
</div>

<print-dialog></print-dialog>
<sign-info-content-dialog></sign-info-content-dialog>
